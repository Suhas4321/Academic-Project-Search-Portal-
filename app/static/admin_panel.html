<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DSCE Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        fontFamily: {
          sans: ['Inter', 'ui-sans-serif', 'system-ui']
        },
        extend: {
          colors: {
            primary: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              200: '#bae6fd',
              300: '#7dd3fc',
              400: '#38bdf8',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              800: '#075985',
              900: '#0c4a6e'
            },
            dark: {
              50: '#f8fafc',
              100: '#f1f5f9',
              200: '#e2e8f0',
              300: '#cbd5e1',
              400: '#94a3b8',
              500: '#64748b',
              600: '#475569',
              700: '#334155',
              800: '#1e293b',
              900: '#0f172a'
            }
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-in-out',
            'slide-up': 'slideUp 0.3s ease-out',
            'pulse-slow': 'pulse 3s infinite',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0', transform: 'translateY(10px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' }
            },
            slideUp: {
              '0%': { opacity: '0', transform: 'translateY(20px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' }
            }
          }
        }
      }
    };
  </script>
  <style>
    .glass-effect {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .hover-lift {
      transition: all 0.3s ease;
    }
    
    .hover-lift:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    
    .table-row-hover:hover {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      transform: scale(1.01);
    }
    
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 3px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
    
    #editModal .modal-scroll {
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .stats-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .upload-zone {
      border: 2px dashed #cbd5e1;
      transition: all 0.3s ease;
    }
    
    .upload-zone:hover {
      border-color: #0ea5e9;
      background-color: #f0f9ff;
    }
    
    .upload-zone.dragover {
      border-color: #0ea5e9;
      background-color: #e0f2fe;
    }
    
    .input-error {
      border-color: #ef4444 !important;
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
    }
    
    .input-valid {
      border-color: #10b981 !important;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1) !important;
    }

    /* NEW: Improved header layout */
    .header-container {
      max-width: none;
      width: 100%;
      padding-left: 2rem;
      padding-right: 2rem;
    }
    
    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
    }
    
    .logo-section {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-shrink: 0;
    }
    
    .profile-section {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-shrink: 0;
    }

    /* Disable table button when no table selected */
    .btn-disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen">
  
  <!-- UPDATED: Header with proper alignment -->
  <header class="gradient-bg shadow-lg">
    <div class="header-container py-4">
      <div class="header-content">
        <!-- Left: Logo and Title -->
        <div class="logo-section">
          <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
            <i class="fas fa-shield-alt text-white text-xl"></i>
          </div>
          <div>
            <h1 class="text-2xl font-bold text-white">DSCE Admin Dashboard</h1>
            <p class="text-blue-100 text-sm">Information Science & Engineering Department</p>
          </div>
        </div>
        
        <!-- Right: Profile Section -->
        <div class="profile-section">
          <div class="text-right text-white">
            <p class="text-sm font-medium">Administrator</p>
            <p class="text-xs text-blue-100">Last login: Today</p>
          </div>
          <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
            <i class="fas fa-user text-white"></i>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Container - UPDATED: Proper width utilization -->
  <div class="w-full px-8 py-8">
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="stats-card rounded-xl p-6 shadow-lg hover-lift">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-blue-100 text-sm font-medium">Total Tables</p>
            <p id="totalTables" class="text-3xl font-bold text-white">0</p>
          </div>
          <div class="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center">
            <i class="fas fa-table text-white text-xl"></i>
          </div>
        </div>
      </div>
      
      <div class="bg-white rounded-xl p-6 shadow-lg hover-lift border border-gray-100">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-600 text-sm font-medium">Total Records</p>
            <p id="totalRecords" class="text-3xl font-bold text-gray-800">0</p>
          </div>
          <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
            <i class="fas fa-database text-green-600 text-xl"></i>
          </div>
        </div>
      </div>
      
      <div class="bg-white rounded-xl p-6 shadow-lg hover-lift border border-gray-100">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-600 text-sm font-medium">System Status</p>
            <p id="activeYear" class="text-2xl font-bold text-gray-800">Active</p>
          </div>
          <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
            <i class="fas fa-check-circle text-orange-600 text-xl"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-100 mb-8">
      <div class="border-b border-gray-200">
        <nav class="flex space-x-8 px-6">
          <button id="tabTables" class="tab-button active py-4 px-2 border-b-2 border-primary-600 font-medium text-primary-600 text-sm">
            <i class="fas fa-table mr-2"></i>Manage Tables
          </button>
          <button id="tabUpload" class="tab-button py-4 px-2 border-b-2 border-transparent font-medium text-gray-500 hover:text-gray-700 text-sm">
            <i class="fas fa-upload mr-2"></i>Upload Data
          </button>
        </nav>
      </div>
    </div>

    <!-- Table Management Section -->
    <div id="tablesSection" class="tab-content">
      <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-semibold text-gray-800 flex items-center">
            <i class="fas fa-table text-primary-600 mr-3"></i>Table Management
          </h2>
          <div class="flex gap-2">
            <button id="refreshBtn" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors flex items-center">
              <i class="fas fa-sync-alt mr-2"></i>Refresh
            </button>
            <!-- UPDATED: Delete Table Button with proper state management -->
            <button id="deleteTableBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center btn-disabled">
              <i class="fas fa-trash-alt mr-2"></i>Delete Table
            </button>
          </div>
        </div>

        <div class="mb-6">
          <label for="tableSelect" class="block text-sm font-medium text-gray-700 mb-2">Select Table to Manage:</label>
          <div class="relative">
            <select id="tableSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-gray-800 bg-white appearance-none">
              <option value="">Choose a table to view and edit...</option>
            </select>
            <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
          </div>
        </div>

        <div id="tableContainer" class="rounded-lg border border-gray-200 shadow-sm mb-6 bg-white overflow-hidden custom-scrollbar"></div>

        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
          <span id="entryCount" class="text-sm text-gray-600 flex items-center">
            <i class="fas fa-info-circle mr-2 text-primary-500"></i>
            Showing 0 of 0 entries
          </span>
          <div class="flex gap-2">
            <button id="prevBtn" class="px-4 py-2 border border-gray-300 rounded-lg bg-white text-gray-700 hover:bg-gray-50 transition-colors flex items-center">
              <i class="fas fa-chevron-left mr-2"></i>Previous
            </button>
            <button id="nextBtn" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors flex items-center">
              Next<i class="fas fa-chevron-right ml-2"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Upload Section -->
    <div id="uploadSection" class="tab-content hidden">
      <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6">
        <div class="mb-6">
          <h2 class="text-xl font-semibold text-gray-800 flex items-center mb-2">
            <i class="fas fa-cloud-upload-alt text-primary-600 mr-3"></i>Import New Table Data
          </h2>
          <p class="text-gray-600 text-sm">Upload Excel files to create new data tables in the system</p>
        </div>

        <!-- Download Excel Format Button -->
        <div class="mb-4">
          <button id="downloadFormatBtn" type="button"
            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center">
            <i class="fas fa-download mr-2"></i>Download Excel Format
          </button>
        </div>

        <form id="excelUploadForm" class="space-y-6" enctype="multipart/form-data">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="new_table" class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-tag mr-2 text-primary-500"></i>Table Name
              </label>
              <input type="text" id="new_table" name="new_table" required
                placeholder="e.g., students_2024, projects_fall, my_data_table"
                class="w-full border border-gray-300 rounded-lg shadow-sm py-3 px-4 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-300" />
              <p id="tableNameHelp" class="text-xs text-gray-500 mt-1">Only letters, numbers, and underscores allowed. Max 63 characters.</p>
              <p id="tableNameError" class="text-xs text-red-600 mt-1 hidden"></p>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-file-excel mr-2 text-green-500"></i>Excel File Upload
              </label>
              <div class="upload-zone rounded-lg p-6 text-center">
                <input type="file" id="excel_file" name="file" accept=".xlsx,.xls,.csv" required class="hidden" />
                <label for="excel_file" class="cursor-pointer">
                  <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                  <p class="text-gray-600 font-medium">Click to upload or drag and drop</p>
                  <p class="text-sm text-gray-500">Excel (.xlsx, .xls) or CSV files only</p>
                </label>
              </div>
              <div id="fileName" class="mt-2 text-sm text-gray-600 hidden"></div>
            </div>
          </div>

          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <h4 class="font-medium text-blue-800 mb-2 flex items-center">
              <i class="fas fa-info-circle mr-2"></i>Upload Requirements
            </h4>
            <ul class="text-sm text-blue-700 space-y-1">
              <li>• Excel file should have headers in the 3rd row</li>
              <li>• Required columns: Group No, USN, Name, Project Title, Guide Name, Outcomes, Proof Link</li>
              <li>• Table name: Only letters, numbers, and underscores (e.g., students_2024, CSE_Projects)</li>
              <li>• File size should be less than 10MB</li>
              <li>• Supports Excel (.xlsx, .xls) and CSV files</li>
            </ul>
          </div>

          <button type="submit" id="uploadBtn" class="w-full py-3 px-6 bg-gradient-to-r from-primary-600 to-primary-700 text-white font-medium rounded-lg hover:from-primary-700 hover:to-primary-800 transition-all duration-300 shadow-lg hover:shadow-xl flex items-center justify-center">
            <i class="fas fa-upload mr-3"></i>Upload and Create Table
          </button>
          
          <div id="excelUploadMsg" class="mt-4 text-center text-sm rounded-lg p-3 hidden"></div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
    <div class="glass-effect rounded-xl shadow-2xl w-full max-w-6xl overflow-hidden animate-slide-up">
      <div class="gradient-bg px-6 py-4">
        <h2 class="text-xl font-semibold text-white flex items-center">
          <i class="fas fa-edit mr-3"></i>Edit Record
        </h2>
      </div>
      <div class="p-6 modal-scroll custom-scrollbar">
        <form id="editForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></form>
        <div class="mt-8 flex justify-end space-x-4 sticky bottom-0 bg-white pt-4 border-t border-gray-200">
          <button id="cancelBtn" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors flex items-center">
            <i class="fas fa-times mr-2"></i>Cancel
          </button>
          <button id="saveBtn" class="px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors flex items-center">
            <i class="fas fa-save mr-2"></i>Save Changes
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- NEW: Delete Confirmation Modal -->
  <div id="deleteConfirmModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-slide-up">
      <div class="bg-red-600 px-6 py-4">
        <h2 class="text-xl font-semibold text-white flex items-center">
          <i class="fas fa-exclamation-triangle mr-3"></i>Delete Table
        </h2>
      </div>
      <div class="p-6">
        <p class="text-gray-700 mb-4">Are you sure you want to delete the table "<span id="deleteTableName" class="font-semibold text-red-600"></span>"?</p>
        <p class="text-sm text-gray-500 mb-6">This action cannot be undone. All data in this table will be permanently lost.</p>
        <div class="flex justify-end space-x-4">
          <button id="cancelDeleteBtn" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
            Cancel
          </button>
          <button id="confirmDeleteBtn" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
            Delete Table
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="fixed inset-0 bg-black/30 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 shadow-2xl flex items-center space-x-4">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"></div>
      <span class="text-gray-700 font-medium">Processing...</span>
    </div>
  </div>
  
  <script>
    // Enhanced table name validation function
    function isValidTableName(name) {
      // Only allow letters, numbers, and underscores, max 63 characters
      return /^[A-Za-z0-9_]{1,63}$/.test(name) && name.length > 0;
    }

    // DOM elements and variables
    const tableSelect = document.getElementById('tableSelect');
    const tableContainer = document.getElementById('tableContainer');
    const entryCount = document.getElementById('entryCount');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const editModal = document.getElementById('editModal');
    const editForm = document.getElementById('editForm');
    const cancelBtn = document.getElementById('cancelBtn');
    const saveBtn = document.getElementById('saveBtn');
    const excelUploadForm = document.getElementById('excelUploadForm');
    const excelUploadMsg = document.getElementById('excelUploadMsg');
    const refreshBtn = document.getElementById('refreshBtn');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const excelFileInput = document.getElementById('excel_file');
    const fileName = document.getElementById('fileName');
    const newTableInput = document.getElementById('new_table');
    const tableNameHelp = document.getElementById('tableNameHelp');
    const tableNameError = document.getElementById('tableNameError');
    const uploadBtn = document.getElementById('uploadBtn');

    // NEW: Delete confirmation modal elements
    const deleteConfirmModal = document.getElementById('deleteConfirmModal');
    const deleteTableName = document.getElementById('deleteTableName');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const deleteTableBtn = document.getElementById('deleteTableBtn');

    // Tab system
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    let currentTable = '';
    let currentData = [];
    let currentPage = 1;
    const pageSize = 10;
    let editingRow = null;

    // UPDATED: Download Excel Format - Redirect to Google Sheets
    document.getElementById('downloadFormatBtn').addEventListener('click', () => {
      window.open('https://docs.google.com/spreadsheets/d/1ntg93G8SV3tDRGomg9ewqbMPyHjImIIq/edit?usp=drivesdk&ouid=103492233788149897665&rtpof=true&sd=true', '_blank');
    });

    // UPDATED: Delete Table with proper confirmation and state management
    deleteTableBtn.addEventListener('click', () => {
      if (!currentTable) {
        // Show better notification instead of alert
        showNotification("Please select a table to delete first.", "warning");
        return;
      }
      
      // Show custom confirmation modal
      deleteTableName.textContent = currentTable;
      deleteConfirmModal.classList.remove('hidden');
      deleteConfirmModal.classList.add('flex');
    });

    // Cancel delete
    cancelDeleteBtn.addEventListener('click', () => {
      deleteConfirmModal.classList.add('hidden');
      deleteConfirmModal.classList.remove('flex');
    });

    // Confirm delete
    confirmDeleteBtn.addEventListener('click', async () => {
      deleteConfirmModal.classList.add('hidden');
      deleteConfirmModal.classList.remove('flex');
      
      showLoading();
      try {
        const resp = await fetch(`/api/admin/tables/${currentTable}`, { method: 'DELETE' });
        const data = await resp.json();
        if (resp.ok && data.success) {
          showNotification(data.message, "success");
          currentTable = '';
          tableSelect.value = '';
          tableContainer.innerHTML = '';
          document.getElementById('totalRecords').textContent = '0';
          updateDeleteButtonState();
          fetchTables();
        } else {
          showNotification(data.detail || 'Error deleting table.', "error");
        }
      } catch (err) {
        showNotification('Network error deleting table.', "error");
      } finally {
        hideLoading();
      }
    });

    // NEW: Update delete button state based on table selection
    function updateDeleteButtonState() {
      if (currentTable) {
        deleteTableBtn.classList.remove('btn-disabled');
      } else {
        deleteTableBtn.classList.add('btn-disabled');
      }
    }

    // NEW: Show notification instead of alerts
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 z-50 max-w-sm p-4 rounded-lg shadow-lg animate-slide-up`;
      
      if (type === 'success') {
        notification.className += ' bg-green-100 text-green-800 border border-green-200';
        notification.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${message}`;
      } else if (type === 'error') {
        notification.className += ' bg-red-100 text-red-800 border border-red-200';
        notification.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>${message}`;
      } else if (type === 'warning') {
        notification.className += ' bg-yellow-100 text-yellow-800 border border-yellow-200';
        notification.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>${message}`;
      } else {
        notification.className += ' bg-blue-100 text-blue-800 border border-blue-200';
        notification.innerHTML = `<i class="fas fa-info-circle mr-2"></i>${message}`;
      }
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 4000);
    }

    // Tab functionality
    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        const targetTab = button.id.replace('tab', '').toLowerCase() + 'Section';
        
        tabButtons.forEach(btn => btn.classList.remove('active', 'border-primary-600', 'text-primary-600'));
        tabButtons.forEach(btn => btn.classList.add('border-transparent', 'text-gray-500'));
        
        button.classList.add('active', 'border-primary-600', 'text-primary-600');
        button.classList.remove('border-transparent', 'text-gray-500');
        
        tabContents.forEach(content => content.classList.add('hidden'));
        document.getElementById(targetTab).classList.remove('hidden');
      });
    });

    // Real-time table name validation with enhanced feedback
    newTableInput.addEventListener('input', function(e) {
      const value = e.target.value.trim();
      const isValid = isValidTableName(value);
      
      // Remove existing classes
      e.target.classList.remove('input-error', 'input-valid');
      tableNameError.classList.add('hidden');
      tableNameHelp.classList.remove('hidden');
      uploadBtn.disabled = false;
      uploadBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      
      if (value.length === 0) {
        // Empty input - neutral state
        return;
      }
      
      if (!isValid) {
        e.target.classList.add('input-error');
        tableNameHelp.classList.add('hidden');
        tableNameError.classList.remove('hidden');
        uploadBtn.disabled = true;
        uploadBtn.classList.add('opacity-50', 'cursor-not-allowed');
        
        // Specific error messages
        if (value.length > 63) {
          tableNameError.textContent = 'Table name too long. Maximum 63 characters allowed.';
        } else if (!/^[A-Za-z0-9_]+$/.test(value)) {
          tableNameError.textContent = 'Invalid characters. Only letters, numbers, and underscores allowed.';
        } else {
          tableNameError.textContent = 'Invalid table name format.';
        }
      } else {
        e.target.classList.add('input-valid');
        tableNameHelp.textContent = `✓ Valid table name (${value.length}/63 characters)`;
        tableNameHelp.classList.remove('text-gray-500');
        tableNameHelp.classList.add('text-green-600');
      }
    });

    // Reset help text when input loses focus
    newTableInput.addEventListener('blur', function(e) {
      if (!e.target.value || isValidTableName(e.target.value)) {
        tableNameHelp.textContent = 'Only letters, numbers, and underscores allowed. Max 63 characters.';
        tableNameHelp.classList.remove('text-green-600');
        tableNameHelp.classList.add('text-gray-500');
      }
    });

    // File upload enhancements
    excelFileInput.addEventListener('change', function(e) {
      if (e.target.files.length > 0) {
        const file = e.target.files[0];
        const fileSize = (file.size / 1024 / 1024).toFixed(2); // MB
        fileName.innerHTML = `<i class="fas fa-file-excel text-green-600 mr-2"></i>Selected: <strong>${file.name}</strong> (${fileSize} MB)`;
        fileName.classList.remove('hidden');
      }
    });

    // Drag and drop functionality
    const uploadZone = document.querySelector('.upload-zone');
    
    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('dragover');
    });
    
    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('dragover');
    });
    
    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        excelFileInput.files = files;
        const file = files[0];
        const fileSize = (file.size / 1024 / 1024).toFixed(2);
        fileName.innerHTML = `<i class="fas fa-file-excel text-green-600 mr-2"></i>Selected: <strong>${file.name}</strong> (${fileSize} MB)`;
        fileName.classList.remove('hidden');
      }
    });

    function showLoading() {
      loadingOverlay.classList.remove('hidden');
      loadingOverlay.classList.add('flex');
    }

    function hideLoading() {
      loadingOverlay.classList.add('hidden');
      loadingOverlay.classList.remove('flex');
    }

    async function fetchTables() {
      showLoading();
      try {
        const res = await fetch('/api/admin/tables');
        const { tables } = await res.json();
        tableSelect.innerHTML = '<option value="">Choose a table to view and edit...</option>';
        tables.forEach(t => {
          const option = document.createElement('option');
          option.value = t;
          option.textContent = t.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
          tableSelect.appendChild(option);
        });
        document.getElementById('totalTables').textContent = tables.length;
      } catch (error) {
        console.error('Error fetching tables:', error);
      } finally {
        hideLoading();
      }
    }

    async function loadTableData(table) {
      showLoading();
      try {
        currentTable = table;
        updateDeleteButtonState(); // Enable delete button when table is selected
        const res = await fetch(`/api/admin/tables/${table}`);
        const { rows } = await res.json();
        currentData = rows;
        currentPage = 1;
        document.getElementById('totalRecords').textContent = rows.length;
        renderTable();
      } catch (error) {
        console.error('Error loading table data:', error);
        tableContainer.innerHTML = '<div class="p-8 text-center text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>Error loading data</div>';
      } finally {
        hideLoading();
      }
    }

    function renderTable() {
      const start = (currentPage - 1) * pageSize;
      const rows = currentData.slice(start, start + pageSize);
      entryCount.innerHTML = `<i class="fas fa-info-circle mr-2 text-primary-500"></i>Showing ${start + 1}-${Math.min(start + pageSize, currentData.length)} of ${currentData.length} entries`;

      if (!rows.length) {
        tableContainer.innerHTML = '<div class="p-8 text-center text-gray-500"><i class="fas fa-inbox text-4xl mb-4"></i><p>No data available in this table</p></div>';
        return;
      }

      const headers = Object.keys(rows[0]);
      let html = `<div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gradient-to-r from-primary-600 to-primary-700">
            <tr>`;
      
      headers.forEach(h => {
        html += `<th class="px-6 py-4 text-left text-xs font-medium text-white uppercase tracking-wider">${h.replace('_', ' ')}</th>`;
      });
      html += '<th class="px-6 py-4 text-left text-xs font-medium text-white uppercase tracking-wider">Actions</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">';

      rows.forEach((row, i) => {
        html += `<tr class="table-row-hover transition-all duration-200">`;
        headers.forEach(h => {
          const value = Array.isArray(row[h]) ? row[h].join(', ') : (row[h] || '-');
          html += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${value}</td>`;
        });
        html += `<td class="px-6 py-4 whitespace-nowrap text-sm space-x-2">
          <button class="editBtn bg-blue-100 text-blue-700 px-3 py-1 rounded-lg hover:bg-blue-200 transition-colors" data-index="${start + i}">
            <i class="fas fa-edit mr-1"></i>Edit
          </button>
          <button class="deleteBtn bg-red-100 text-red-700 px-3 py-1 rounded-lg hover:bg-red-200 transition-colors" data-id="${row.group_no}">
            <i class="fas fa-trash mr-1"></i>Delete
          </button>
        </td></tr>`;
      });

      html += '</tbody></table></div>';
      tableContainer.innerHTML = html;

      document.querySelectorAll('.editBtn').forEach(btn => btn.addEventListener('click', () => openEditModal(currentData[btn.dataset.index])));
      document.querySelectorAll('.deleteBtn').forEach(btn => btn.addEventListener('click', () => deleteRow(btn.dataset.id)));
    }

    function openEditModal(row) {
      editingRow = row;
      editForm.innerHTML = '';
      Object.entries(row).forEach(([key, val]) => {
        const isDisabled = key === 'group_no';
        const displayName = key.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
        const fieldValue = Array.isArray(val) ? val.join(', ') : (val || '');
        
        editForm.insertAdjacentHTML('beforeend', `
          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">${displayName}</label>
            <input name="${key}" value="${fieldValue}" ${isDisabled ? 'disabled' : ''} 
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 ${isDisabled ? 'bg-gray-100' : ''}" />
          </div>
        `);
      });
      editModal.classList.remove('hidden');
      editModal.classList.add('flex');
    }

    saveBtn.onclick = async () => {
      showLoading();
      try {
        const formData = new FormData(editForm);
        const updated = {};
        formData.forEach((val, key) => {
          updated[key] = val.includes(',') ? val.split(',').map(v => v.trim()) : val;
        });
        await fetch(`/api/admin/tables/${currentTable}/${editingRow.group_no}`, {
          method: 'PUT', 
          headers: { 'Content-Type': 'application/json' }, 
          body: JSON.stringify(updated)
        });
        closeEditModal();
        loadTableData(currentTable);
        showNotification("Record updated successfully!", "success");
      } catch (error) {
        console.error('Error saving changes:', error);
        showNotification("Error updating record.", "error");
      } finally {
        hideLoading();
      }
    };

    cancelBtn.onclick = closeEditModal;
    function closeEditModal() {
      editModal.classList.add('hidden');
      editModal.classList.remove('flex');
    }

    async function deleteRow(id) {
      if (!confirm('Are you sure you want to delete this record? This action cannot be undone.')) return;
      showLoading();
      try {
        await fetch(`/api/admin/tables/${currentTable}/${id}`, { method: 'DELETE' });
        loadTableData(currentTable);
        showNotification("Record deleted successfully!", "success");
      } catch (error) {
        console.error('Error deleting row:', error);
        showNotification("Error deleting record.", "error");
      } finally {
        hideLoading();
      }
    }

    // UPDATED: Event listeners with proper state management
    tableSelect.onchange = e => {
      if (e.target.value) {
        loadTableData(e.target.value);
      } else {
        currentTable = '';
        updateDeleteButtonState();
        tableContainer.innerHTML = '';
        document.getElementById('totalRecords').textContent = '0';
      }
    };

    prevBtn.onclick = () => { if (currentPage > 1) { currentPage--; renderTable(); } };
    nextBtn.onclick = () => { if ((currentPage * pageSize) < currentData.length) { currentPage++; renderTable(); } };
    refreshBtn.onclick = fetchTables;

    // Excel Upload Handler with enhanced validation
    excelUploadForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const tableName = newTableInput.value.trim();
      
      // Final validation before submitting
      if (!isValidTableName(tableName)) {
        excelUploadMsg.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Please enter a valid table name before uploading.';
        excelUploadMsg.className = 'mt-4 text-center text-sm rounded-lg p-3 bg-red-100 text-red-800 border border-red-200';
        excelUploadMsg.classList.remove('hidden');
        newTableInput.focus();
        return;
      }
      
      showLoading();
      excelUploadMsg.classList.add('hidden');
      
      const formData = new FormData(excelUploadForm);

      try {
        const resp = await fetch('/api/admin/upload-excel', {
          method: 'POST',
          body: formData,
          credentials: 'include'
        });
        const data = await resp.json();
        
        if (resp.ok && data.success) {
          excelUploadMsg.innerHTML = `<i class="fas fa-check-circle mr-2"></i>✅ Table "${tableName}" uploaded successfully! ${data.rows_imported} records imported.`;
          excelUploadMsg.className = 'mt-4 text-center text-sm rounded-lg p-3 bg-green-100 text-green-800 border border-green-200';
          excelUploadMsg.classList.remove('hidden');
          excelUploadForm.reset();
          fileName.classList.add('hidden');
          // Reset input styling
          newTableInput.classList.remove('input-error', 'input-valid');
          tableNameError.classList.add('hidden');
          tableNameHelp.classList.remove('hidden', 'text-green-600');
          tableNameHelp.classList.add('text-gray-500');
          tableNameHelp.textContent = 'Only letters, numbers, and underscores allowed. Max 63 characters.';
          uploadBtn.disabled = false;
          uploadBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          fetchTables();
          showNotification(`Table "${tableName}" created successfully!`, "success");
        } else {
          excelUploadMsg.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>${data.detail || 'Upload failed.'}`;
          excelUploadMsg.className = 'mt-4 text-center text-sm rounded-lg p-3 bg-red-100 text-red-800 border border-red-200';
          excelUploadMsg.classList.remove('hidden');
        }
      } catch (err) {
        excelUploadMsg.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Network error. Please try again.';
        excelUploadMsg.className = 'mt-4 text-center text-sm rounded-lg p-3 bg-red-100 text-red-800 border border-red-200';
        excelUploadMsg.classList.remove('hidden');
      } finally {
        hideLoading();
      }
    });

    // Initialize
    fetchTables();
    updateDeleteButtonState(); // Set initial state for delete button
  </script>
</body>
</html>
